# 本地部署需求文档

## 介绍

本规格旨在实现 RAGFlow 系统的混合部署模式：在现有 Docker 部署的基础上，将 RAGFlow 主服务从容器中迁移到本地运行（便于开发调试），而基础设施组件（MySQL、Redis、MinIO、Elasticsearch）继续复用现有的 Docker 容器。这种部署方式既保持了基础设施的稳定性和一致性，又提供了主服务的开发灵活性。

**重要说明**：本功能将在专门的 feature 分支上开发，以便将来合并到其他版本或贡献到 RAGFlow 官方仓库，确保代码的可追溯性和版本管理的规范性。

## 与产品愿景的对齐

此功能支持产品纲要中的以下目标：
- **开发者友好**：为企业开发者提供更灵活的部署和调试环境
- **易于集成**：简化开发环境搭建，降低贡献门槛
- **技术可控**：开发者可以直接修改和调试核心代码
- **渐进式部署**：支持从开发环境到生产环境的平滑过渡

## 需求

### 需求 1：Feature 分支管理与代码同步

**用户故事：** 作为开发者，我希望在专门的 feature 分支上进行本地部署功能开发，以便将来能够合并到其他版本或贡献到 RAGFlow 官方仓库。

#### 验收标准

1. WHEN 开始开发 THEN 系统 SHALL 创建专门的 feature 分支（如 feature/local-deployment）
2. WHEN 拉取最新代码 THEN 系统 SHALL 先更新主分支，再合并到 feature 分支
3. IF 本地有未提交的更改 THEN 系统 SHALL 提示用户处理冲突或暂存更改
4. WHEN 代码更新完成 THEN 系统 SHALL 验证代码完整性和分支状态
5. WHEN 功能完成 THEN 系统 SHALL 支持创建 Pull Request 到官方仓库

### 需求 2：混合部署模式配置

**用户故事：** 作为开发者，我希望能够复用现有的 Docker 基础设施容器，但将 RAGFlow 主服务切换为本地运行，以便进行开发和调试。

#### 验收标准

1. WHEN 检测现有 Docker 环境 THEN 系统 SHALL 识别并复用正在运行的基础设施容器
2. IF 基础设施容器未运行 THEN 系统 SHALL 启动必要的容器（MySQL、Redis、MinIO、Elasticsearch）
3. WHEN 配置混合部署 THEN 系统 SHALL 停止 Docker 中的 RAGFlow 服务容器
4. WHEN 基础设施就绪 THEN 系统 SHALL 验证本地服务与容器化组件的连通性

### 需求 3：本地 RAGFlow 服务配置

**用户故事：** 作为开发者，我希望 RAGFlow 主服务在本地运行，并能正确连接到 Docker 容器中的基础设施。

#### 验收标准

1. WHEN 配置本地服务 THEN 系统 SHALL 生成适配的配置文件
2. IF 容器服务地址发生变化 THEN 系统 SHALL 自动更新连接配置
3. WHEN 本地服务启动 THEN 系统 SHALL 验证与所有依赖服务的连接
4. WHEN 服务运行 THEN 系统 SHALL 保持与原 Docker 部署相同的功能

### 需求 4：环境依赖管理

**用户故事：** 作为开发者，我希望系统能自动安装和管理 Python 依赖，以便快速搭建开发环境。

#### 验收标准

1. WHEN 检查环境 THEN 系统 SHALL 验证 Python 版本兼容性（3.10-3.12）
2. IF 缺少依赖包 THEN 系统 SHALL 使用 uv 自动安装
3. WHEN 安装依赖 THEN 系统 SHALL 使用 pyproject.toml 和 uv.lock 确保版本一致性
4. WHEN 依赖安装完成 THEN 系统 SHALL 验证关键包的可用性

### 需求 5：开发调试支持

**用户故事：** 作为开发者，我希望能够方便地调试和修改代码，以便进行功能开发和问题排查。

#### 验收标准

1. WHEN 启动调试模式 THEN 系统 SHALL 支持热重载和断点调试
2. IF 启用调试端口 THEN 系统 SHALL 配置 debugpy 监听指定端口
3. WHEN 代码发生变更 THEN 系统 SHALL 自动重启服务（可选）
4. WHEN 运行测试 THEN 系统 SHALL 支持单元测试和集成测试

### 需求 6：配置兼容性保证

**用户故事：** 作为开发者，我希望本地部署的配置与 Docker 部署完全一致，以便确保功能的一致性。

#### 验收标准

1. WHEN 生成配置 THEN 系统 SHALL 使用与 docker-compose.yml 相同的环境变量
2. IF 配置文件存在差异 THEN 系统 SHALL 提供配置对比和同步功能
3. WHEN 服务启动 THEN 系统 SHALL 验证配置的正确性
4. WHEN 切换部署模式 THEN 系统 SHALL 保持数据和配置的兼容性

## 非功能性需求

### 代码架构和模块化
- **单一职责原则**：部署脚本应职责明确，分离基础设施管理和应用启动逻辑
- **模块化设计**：配置管理、服务启动、健康检查应独立模块化
- **依赖管理**：最小化对系统环境的依赖，优先使用容器化组件
- **清晰接口**：提供统一的命令行接口和配置文件格式

### 性能
- 基础设施容器启动时间应在 2 分钟内
- 本地服务启动时间应在 30 秒内
- 配置文件生成和验证应在 5 秒内完成

### 安全
- 敏感配置信息（数据库密码、API 密钥）应通过环境变量管理
- 容器间通信应使用内部网络，避免暴露不必要的端口
- 本地服务应支持 HTTPS 配置（可选）

### 可靠性
- 服务启动失败时应提供详细的错误信息和解决建议
- 支持服务健康检查和自动重启机制
- 配置变更应支持回滚操作

### 可用性
- 提供简单易懂的命令行界面
- 支持一键启动和停止操作
- 提供详细的日志输出和状态监控
- 支持 Windows、macOS、Linux 多平台部署

### 兼容性
- 与现有 Docker Compose 配置保持 100% 兼容
- 支持从 Docker 部署平滑迁移到混合部署
- 向后兼容现有的配置文件和数据格式
